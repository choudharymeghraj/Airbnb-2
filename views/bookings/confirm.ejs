<% layout('/layouts/boilerplate') %>

<style>
  .booking-image-container {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    height: 280px;
    margin-bottom: 20px;
  }

  .booking-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .booking-image-container:hover img {
    transform: scale(1.05);
  }

  .booking-card {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: box-shadow 0.3s ease;
  }

  .booking-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  }

  .price-summary-card {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    position: sticky;
    top: 20px;
  }

  .booking-detail-row {
    padding: 16px;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 10px;
    border-left: 4px solid #ff385c;
    transition: all 0.3s ease;
  }

  .booking-detail-row:hover {
    background: linear-gradient(135deg, #fff5f7 0%, #ffffff 100%);
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(255, 56, 92, 0.15);
  }

  .booking-detail-row:last-child {
    margin-bottom: 0;
  }

  .booking-detail-label {
    color: #484848;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }

  .booking-detail-label i {
    color: #ff385c;
    margin-right: 10px;
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
  }

  .booking-detail-value {
    color: #222222;
    font-weight: 700;
    font-size: 1.1rem;
    padding-left: 30px;
  }

  .booking-details-title {
    color: #222222;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #ff385c;
  }

  .listing-title-badge {
    display: inline-block;
    background: linear-gradient(135deg, #ff385c 0%, #e61e4d 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .pay-btn {
    background: linear-gradient(135deg, #ff385c 0%, #e61e4d 100%);
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .pay-btn:hover {
    background: linear-gradient(135deg, #e61e4d 0%, #d70466 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(230, 30, 77, 0.4);
  }

  .location-icon {
    color: #ff385c;
    margin-right: 5px;
  }
</style>

<div class="container my-4">

  <h2 class="fw-bold mb-4">Review your booking</h2>

  <div class="row">
    
    <!-- LEFT: Details -->
    <div class="col-lg-7">

      <!-- Listing Image -->
      <div class="booking-image-container">
        <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="listing-image">
      </div>

      <div class="card booking-card mb-3">
        <div class="card-body">
          <span class="listing-title-badge"><%= listing.category %></span>
          <h5 class="fw-bold mb-2"><%= listing.title %></h5>
          <p class="text-muted mb-0">
            <i class="fas fa-map-marker-alt location-icon"></i>
            <%= listing.location %>, <%= listing.country %>
          </p>
        </div>
      </div>

      <div class="card booking-card mb-3">
        <div class="card-body">
          <h6 class="booking-details-title">
            <i class="fas fa-calendar-check"></i> Your Trip Details
          </h6>
          
          <div class="booking-detail-row">
            <div class="booking-detail-label">
              <i class="fas fa-calendar-day"></i>
              Check-in
            </div>
            <div class="booking-detail-value"><%= bookingData.checkIn %></div>
          </div>

          <div class="booking-detail-row">
            <div class="booking-detail-label">
              <i class="fas fa-calendar-times"></i>
              Check-out
            </div>
            <div class="booking-detail-value"><%= bookingData.checkOut %></div>
          </div>

          <div class="booking-detail-row">
            <div class="booking-detail-label">
              <i class="fas fa-moon"></i>
              Total Nights
            </div>
            <div class="booking-detail-value"><%= bookingData.nights %> night<%= bookingData.nights > 1 ? 's' : '' %></div>
          </div>

          <div class="booking-detail-row">
            <div class="booking-detail-label">
              <i class="fas fa-user-friends"></i>
              Guests
            </div>
            <div class="booking-detail-value"><%= bookingData.guests %> guest<%= bookingData.guests > 1 ? 's' : '' %></div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT: Price summary -->
    <div class="col-lg-5">
      <div class="card price-summary-card p-4">
        <h5 class="fw-bold mb-4">Price summary</h5>

        <% 
          const price = listing.price;
          const nights = parseInt(bookingData.nights);
          const subtotal = price * nights;
          const tax = Math.round(subtotal * 0.18);
          const total = subtotal + tax;
        %>

        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted">₹<%= price.toLocaleString('en-IN') %> × <%= nights %> nights</span>
          <span class="fw-semibold">₹<%= (price * nights).toLocaleString('en-IN') %></span>
        </div>

        <div class="d-flex justify-content-between mb-3 text-success">
          <span>GST (18%)</span>
          <span class="fw-semibold">₹<%= tax.toLocaleString('en-IN') %></span>
        </div>

        <hr class="my-3">

        <div class="d-flex justify-content-between fw-bold fs-5 mb-4">
          <span>Total</span>
          <span>₹<%= total.toLocaleString('en-IN') %></span>
        </div>

        <!-- RAZORPAY BUTTON -->
        <button id="payBtn" class="btn btn-danger w-100 pay-btn">
          Pay & Confirm
        </button>

      </div>
    </div>

  </div>

</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  const payBtn = document.getElementById("payBtn");

  payBtn.addEventListener("click", async function () {

    // 1️⃣ Request backend to create Razorpay order
    const res = await fetch("/listings/<%= listing._id %>/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        booking: {
          checkIn: "<%= bookingData.checkIn %>",
          checkOut: "<%= bookingData.checkOut %>",
          nights: "<%= bookingData.nights %>",
          guests: "<%= bookingData.guests %>"
        }
      }),
    });

    const data = await res.json();

    if (!data.success) {
      alert("Error creating order: " + data.message);
      return;
    }

    // 2️⃣ Configure Razorpay
    const options = {
      key: data.key,
      amount: data.amount,
      currency: data.currency,
      name: "<%= listing.title %>",
      description: "Booking payment",
      order_id: data.order.id,

      handler: async function (response) {
        // 3️⃣ Verify payment on backend
        const verifyRes = await fetch("/bookings/verify-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            bookingId: data.bookingId
          }),
        });

        const verifyData = await verifyRes.json();
        
        if (verifyData.success) {
          // 4️⃣ Redirect to success page
          window.location.href = `/bookings/${data.bookingId}/success`;
        } else {
          alert("Payment verification failed!");
        }
      },

      theme: { color: "#ff385c" }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  });
</script>
