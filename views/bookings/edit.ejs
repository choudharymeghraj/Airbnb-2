<% layout("/layouts/boilerplate") %>

<div class="row">
    <div class="col-8 offset-2">
        
        <!-- Your existing listing card code stays here -->
        <div class="card mb-3">
            <img src="<%= listing.image.url %>" class="card-img-top" alt="listing_image">
            <div class="card-body">
                <p class="card-text">
                    <b><%= listing.title %></b><br/>
                    <%= listing.description %><br/>
                    &#8377; <%= listing.price.toLocaleString("en-IN") %><br/>
                    <%= listing.location %><br/>
                    <%= listing.country %>
                </p>
            </div>
        </div>

        <!-- Edit/Delete buttons (if you have them) -->
        
        <hr>

        <!-- ALL REVIEWS SECTION -->
        <% if (listing.reviews && listing.reviews.length > 0) { %>
            <div class="mt-4 mb-4">
                <h4><i class="fa-solid fa-comments"></i> All Reviews (<%= listing.reviews.length %>)</h4>
                
                <!-- Average Rating -->
                <% 
                const totalRating = listing.reviews.reduce((sum, r) => sum + r.rating, 0);
                const avgRating = totalRating / listing.reviews.length;
                %>
                
                <div class="average-rating-box mb-4">
                    <div class="average-rating-number"><%= avgRating.toFixed(1) %></div>
                    <div class="average-rating-stars">
                        <% for(let i = 1; i <= 5; i++) { %>
                            <span class="star <%= i <= Math.round(avgRating) ? 'filled' : '' %>">★</span>
                        <% } %>
                    </div>
                    <div class="total-reviews-text">
                        Based on <%= listing.reviews.length %> review<%= listing.reviews.length !== 1 ? 's' : '' %>
                    </div>
                </div>
                
                <!-- Individual Reviews -->
                <% for(let review of listing.reviews) { %>
                    <div class="card review-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="reviewer-avatar">
                                        <%= review.author.username.charAt(0).toUpperCase() %>
                                    </div>
                                    <div>
                                        <h6 class="mb-0"><%= review.author.username %></h6>
                                        <small class="text-muted">Verified Guest</small>
                                    </div>
                                </div>
                                
                                <% if(currentUser && review.author._id.equals(currentUser._id)) { %>
                                    <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                        <button class="btn btn-sm btn-outline-danger">
                                            <i class="fa-solid fa-trash"></i> Delete
                                        </button>
                                    </form>
                                <% } %>
                            </div>
                            
                            <!-- Star Rating Display -->
                            <div class="review-stars mb-2">
                                <% for(let i = 1; i <= 5; i++) { %>
                                    <span class="star <%= i <= review.rating ? 'filled' : 'empty' %>">★</span>
                                <% } %>
                            </div>
                            
                            <p class="card-text"><%= review.comment %></p>
                            <small class="text-muted">
                                <%= review.createdAt.toLocaleDateString('en-IN', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                }) %>
                            </small>
                        </div>
                    </div>
                <% } %>
            </div>
        <% } %>

        <hr>

        <!-- LEAVE A REVIEW FORM -->
        <% if(currentUser) { %>
            <div class="mb-3">
                <h4><i class="fa-solid fa-star"></i> Leave a Review</h4>
                <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                    
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="star-rating-input">
                            <input type="radio" id="star5" name="review[rating]" value="5" required>
                            <label for="star5" class="star">★</label>
                            
                            <input type="radio" id="star4" name="review[rating]" value="4">
                            <label for="star4" class="star">★</label>
                            
                            <input type="radio" id="star3" name="review[rating]" value="3">
                            <label for="star3" class="star">★</label>
                            
                            <input type="radio" id="star2" name="review[rating]" value="2">
                            <label for="star2" class="star">★</label>
                            
                            <input type="radio" id="star1" name="review[rating]" value="1">
                            <label for="star1" class="star">★</label>
                        </div>
                        <div class="rating-text mt-2"></div>
                        <div class="invalid-feedback">Please select a rating</div>
                    </div>

                    <div class="mb-3">
                        <label for="comment" class="form-label">Comments</label>
                        <textarea 
                            class="form-control" 
                            name="review[comment]" 
                            id="comment" 
                            cols="30" 
                            rows="5" 
                            placeholder="Share your experience with this listing..."
                            required
                        ></textarea>
                        <div class="invalid-feedback">Please add a comment</div>
                    </div>

                    <button class="btn btn-dark">Submit</button>
                </form>
            </div>
        <% } %>

    </div>
</div>

<script>
// Star rating feedback
const ratingInputs = document.querySelectorAll('.star-rating-input input');
const ratingText = document.querySelector('.rating-text');

if (ratingInputs.length > 0 && ratingText) {
    const labels = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
    
    ratingInputs.forEach(input => {
        input.addEventListener('change', function() {
            const value = this.value;
            ratingText.textContent = `${value} star${value > 1 ? 's' : ''} - ${labels[value - 1]}`;
            ratingText.style.color = '#ffc107';
            ratingText.style.fontWeight = 'bold';
        });
    });
}
</script>
